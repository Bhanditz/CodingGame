<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>
    <!--Skulpt runtime-->
    <script src="static/skulpt.min.js" type="text/javascript"></script>
    <script src="static/skulpt-stdlib.js" type="text/javascript"></script>

    <link rel="stylesheet" type="text/css" media="all" href="static/codemirror.css">
    <link rel="stylesheet" type="text/css" media="all" href="static/solarized.css">
    <link rel="stylesheet" type="text/css" media="all" href="static/main.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="static/codemirrorepl.js" type="text/javascript"></script>
    <script src="static/python.js" type="text/javascript"></script>
    <script src="static/env/editor.js" type="text/javascript"></script>

    <!--Elm runtime-->
    <script src="static/elm-runtime.js" type="text/javascript"></script>

    <!--Game logic in Elm-->
    <script src="build/Game.js" type="text/javascript"></script>
    <script src="build/Levels.js" type="text/javascript"></script>

    <style>

        html {
            overflow-y: hidden;
        }

        #column-code-wrap {
            float: top;
            height: 100%;
        }

        #column-code {
            margin-bottom: 100px;
        }

        #game {
            width: 100%;
            height: 200px;
            float: top;
            background-color: white;
            border: 1px solid #babdb6;
        }

        #clear {
            clear: both;
        }
    </style>

</head>

<body>

<script type="text/javascript">
    // output functions are configurable.  This one just appends some text
    // to a pre element.
    function outf(text) {
        var mypre = document.getElementById("output");
        mypre.innerHTML = mypre.innerHTML + text;
    }
    function builtinRead(x) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
            throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
    }

</script>


<h1>Coding game</h1>

<div class="page">
    <div class="body">
        <div class="main">

<div id="code-column-wrap">
    <div id="code-column">
    <form>
      <textarea id="code" style="width:500;height:30%"></textarea><br />



<button type="button" id="skulpt_run">Run</button>
</form></div>
</div>


        </div>
    </div>
</div>

<div id="game"></div>

<div id="clear"></div>

</body>

<script type="text/javascript">
    jQuery.ajaxSetup({async:false});
    // TODO: Fix
    Sk.builtinFiles["files"]['src/lib/game.py'] = jQuery.get("game.py").responseText;


    $(document).ready(function () {
        editor.setValue(jQuery.get("initial_code.py").responseText);


        var div = document.getElementById('game');
        var game = Elm.embed(Elm.Game, div, { code_port: "" });
        var fun;
        var infoConstructor;
        game.ports.messageOut.subscribe(function(param){
            try {
                if (fun) {

                    var heroInfo = Sk.misceval.callsim(infoConstructor, param.hero_x, param.hero_y);
                    var command = Sk.misceval.callsim(fun, heroInfo);
                    var result = Sk.ffi.remapToJs(Sk.misceval.callsim(command.tp$getattr("_get_dict")));

                    if (result) {
                        game.ports.code_port.send(result);
                    }
                 }
            }catch (ex) {
                alert(ex);
            }
        });

        $(document).bind("codeLaunched", function (event, module) {
            try {
                fun = module.tp$getattr('hero_action');

                if (! fun) {
                    alert("function hero_action not found");
                }

                var gameModule = Sk.importModule("game");
                infoConstructor = gameModule.tp$getattr('GameInfo');
                if (!infoConstructor) {
                    alert("failed to load game.GameInfo");
                }

            } catch (ex) {
                alert("Error codeLaunched:" + ex);
            }
        });

    });
    // Show the stamp module in the "elm-stamps" div.


    // Translate Python to JS and sends to the Elm code.

    // Always show the latest count of stamps, which is exported
    // from the Stamps module as the 'count' event stream.
    var currentCount = document.getElementById('current-count'),
            totalCount = document.getElementById('total-count'),
            total = 0;

</script>

</html> 
